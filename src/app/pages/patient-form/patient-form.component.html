<section class="page-header">
  <div class="page-header-title">
    <h5>Cadastro de paciente</h5>
  </div>
  <div class="page-header-breadcrumb">
    <ul class="breadcrumb">
      <li class="breadcrumb-item">
        <a routerLink="/home"><i class="feather icon-home"></i></a>
      </li>
      <li class="breadcrumb-item">
        <a routerLink="/patient-configurator">Configurador</a>
      </li>
      <li class="breadcrumb-item">
        <a routerLink="/patient-configurator/patients">Pacientes</a>
      </li>
      <li class="breadcrumb-item">Cadastro</li>
    </ul>
  </div>
</section>

<div class="row">
  <div class="col-xl-12">
    <div class="card">
      <div class="card-header">
        <h5>{{ formTitle() }}</h5>
      </div>
      <div class="card-body">
        <form (submit)="onSubmit($event)" autocomplete="off" method="post">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-name">Nome</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().name"
                  readonly
                />
              } @else {
                <input
                  id="patient-name"
                  type="text"
                  class="form-control"
                  autocomplete="off"
                  [field]="patientForm.name"
                  [class.is-invalid]="submitted() && patientForm.name().invalid()"
                  placeholder="Nome completo"
                />
                @if (submitted() && patientForm.name().invalid()) {
                  <div class="invalid-feedback">
                    @for (error of patientForm.name().errors(); track error.kind) {
                      <div>{{ error.message }}</div>
                    }
                  </div>
                }
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-birthday">Data de nascimento</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().birthday | date:'dd/MM/yyyy'"
                  readonly
                />
              } @else {
                <input
                  id="patient-birthday"
                  type="date"
                  class="form-control"
                  [field]="patientForm.birthday"
                  [class.is-invalid]="submitted() && patientForm.birthday().invalid()"
                />
                @if (submitted() && patientForm.birthday().invalid()) {
                  <div class="invalid-feedback">
                    @for (error of patientForm.birthday().errors(); track error.kind) {
                      <div>{{ error.message }}</div>
                    }
                  </div>
                }
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-contact">Contato</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().closerContact | phoneMask"
                  readonly
                />
              } @else {
                <input
                  id="patient-contact"
                  type="tel"
                  class="form-control"
                  autocomplete="off"
                  [field]="patientForm.closerContact"
                  (input)="onContactInput($event)"
                  [class.is-invalid]="submitted() && patientForm.closerContact().invalid()"
                  placeholder="Telefone"
                />
                @if (submitted() && patientForm.closerContact().invalid()) {
                  <div class="invalid-feedback">
                    @for (error of patientForm.closerContact().errors(); track error.kind) {
                      <div>{{ error.message }}</div>
                    }
                  </div>
                }
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-sex">Sexo</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().sex === 'masculino' ? 'Masculino' : patientModel().sex === 'feminino' ? 'Feminino' : ''"
                  readonly
                />
              } @else {
                <select
                  id="patient-sex"
                  class="form-select"
                  [field]="patientForm.sex"
                  [class.is-invalid]="submitted() && patientForm.sex().invalid()"
                >
                  <option value="">Selecione</option>
                  <option value="masculino">Masculino</option>
                  <option value="feminino">Feminino</option>
                </select>
                @if (submitted() && patientForm.sex().invalid()) {
                  <div class="invalid-feedback">
                    @for (error of patientForm.sex().errors(); track error.kind) {
                      <div>{{ error.message }}</div>
                    }
                  </div>
                }
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-plan-id">Plano</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().planName"
                  readonly
                />
              } @else {
                <select
                  id="patient-plan-id"
                  class="form-select"
                  [field]="patientForm.planId"
                  [class.is-invalid]="submitted() && patientForm.planId().invalid()"
                >
                  <option value="">Selecione</option>
                  @for (plan of plans(); track plan.id) {
                    <option [value]="plan.id">{{ plan.name }}</option>
                  }
                </select>
                @if (submitted() && patientForm.planId().invalid()) {
                  <div class="invalid-feedback">
                    @for (error of patientForm.planId().errors(); track error.kind) {
                      <div>{{ error.message }}</div>
                    }
                  </div>
                }
              }
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label" for="patient-height">Altura (cm)</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().heightCm"
                  readonly
                />
              } @else {
                <input
                  id="patient-height"
                  type="text"
                  class="form-control"
                  autocomplete="off"
                  [field]="patientForm.heightCm"
                  placeholder="Ex: 170"
                />
              }
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label" for="patient-weight">Peso (kg)</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().weightKg"
                  readonly
                />
              } @else {
                <input
                  id="patient-weight"
                  type="text"
                  class="form-control"
                  autocomplete="off"
                  [field]="patientForm.weightKg"
                  placeholder="Ex: 70"
                />
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-diseases">Doenças</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="getDiseasesNames()"
                  readonly
                />
              } @else {
                <mat-form-field class="diseases-field" appearance="outline">
                  <mat-select
                    id="patient-diseases"
                    multiple
                    [value]="patientModel().diseases"
                    (selectionChange)="onDiseasesChange($event.value)"
                    panelClass="diseases-panel"
                  >
                    @for (disease of diseases(); track disease.id) {
                      <mat-option [value]="disease.id">{{ disease.name }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-cpf">CPF</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().cpf | cpfMask"
                  readonly
                />
              } @else {
                <input
                  id="patient-cpf"
                  type="text"
                  class="form-control"
                  autocomplete="off"
                  [value]="patientModel().cpf"
                  (input)="onCpfInput($event)"
                  placeholder="000.000.000-00"
                  maxlength="14"
                />
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-rg">RG</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().rg | rgMask"
                  readonly
                />
              } @else {
                <input
                  id="patient-rg"
                  type="text"
                  class="form-control"
                  autocomplete="off"
                  [value]="patientModel().rg"
                  (input)="onRgInput($event)"
                  placeholder="00.000.000-0"
                  maxlength="12"
                />
              }
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label" for="patient-custom-value">Valor personalizado (R$)</label>
              @if (isViewMode()) {
                <input
                  type="text"
                  class="form-control readonly-field"
                  [value]="patientModel().customValue | currencyBrl"
                  readonly
                />
              } @else {
                <input
                  id="patient-custom-value"
                  type="text"
                  class="form-control"
                  autocomplete="off"
                  [value]="patientModel().customValue"
                  (input)="onCurrencyInput($event)"
                  placeholder="R$ 0,00"
                />
                <small class="form-text text-muted">Deixe vazio para usar o valor do plano</small>
              }
            </div>
            <div class="col-12 mb-3">
              <label class="form-label" for="patient-observation">Observação</label>
              @if (isViewMode()) {
                <textarea
                  class="form-control readonly-field"
                  [value]="patientModel().observation"
                  readonly
                  rows="3"
                ></textarea>
              } @else {
                <textarea
                  id="patient-observation"
                  class="form-control"
                  autocomplete="off"
                  [field]="patientForm.observation"
                  placeholder="Informações adicionais sobre o paciente..."
                  rows="3"
                ></textarea>
              }
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" (click)="cancel()">
              {{ isViewMode() ? 'Voltar' : 'Cancelar' }}
            </button>
            @if (!isViewMode()) {
              <button type="submit" class="btn btn-primary">Salvar</button>
            }
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
